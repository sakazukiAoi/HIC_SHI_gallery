<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¤ãƒ©ã‚¹ãƒˆã‚®ãƒ£ãƒ©ãƒªãƒ¼</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<style>
body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
h1 { display: none; /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’éè¡¨ç¤ºã« */ }
h2 { border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-top: 0; }
.gallery-section { margin-bottom: 40px; padding: 20px; border: 1px solid #eee; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

/* === Google Fonts Material Symbols Icons === */
.material-symbols-outlined {
    /* ã‚¢ã‚¤ã‚³ãƒ³ã®è¦–è¦šçš„ãªè¨­å®š */
    font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
    
    /* ã‚¢ã‚¤ã‚³ãƒ³ãƒ•ã‚©ãƒ³ãƒˆã®åŸºæœ¬çš„ãªè¨­å®š */
    font-family: 'Material Symbols Outlined';
    font-weight: normal;
    font-style: normal;
    font-size: 24px;
    line-height: 1;
    letter-spacing: normal;
    text-transform: none;
    display: inline-block;
    white-space: nowrap;
    word-wrap: normal;
    direction: ltr;
    -webkit-font-feature-settings: "liga";
    -webkit-font-smoothing: antialiased;
}
/* ================================== */

/* --- ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒœã‚¿ãƒ³ã®é…ç½® --- */
#galleryHeader {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}
#galleryHeader h2 {
    margin: 0;
    margin-right: 15px;
    border-bottom: none;
    padding-bottom: 0;
}
#sortButtons {
    display: flex;
    gap: 10px;
}
#sortButtons button {
    background-color: #6c757d;
    color: white; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 6px 10px;
    font-size: 0.9em;
    height: 35px;
}
#sortButtons button:hover {
    background-color: #5a6268;
}

#sortButtons button span + * {
    display: none; 
}


/* --- ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
.gallery-grid {
display: grid;
/* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: PC/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãªã©ã§3åˆ—ä»¥ä¸Š */
grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
gap: 0;
}

/* â˜…ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚µã‚¤ã‚º (600pxä»¥ä¸‹) ã§ã¯2åˆ—ã«ã™ã‚‹ */
@media (max-width: 600px) {
    .gallery-grid {
        /* ç”»é¢å¹…ã®ç´„åŠåˆ†ã®ã‚µã‚¤ã‚ºã§2åˆ—ã«å›ºå®š */
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
}

.work-card {
border: 1px solid #ddd;
padding: 0;
background-color: #fff;
box-shadow: 0 0 5px rgba(0,0,0,0.1);
position: relative;
width: 100%;
}

/* --- ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ --- */
.thumbnail-container { 
    width: 100%; 
    position: relative; 
    overflow: hidden; 
    margin-bottom: 0; 
    display: block; 
    /* min-height: 180px;  â† å‰Šé™¤ */
}

/* â˜…æ­£æ–¹å½¢(ã‚¹ã‚¯ã‚¨ã‚¢)ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®ä¿®æ­£ */
.thumbnail-image { 
    position: absolute; /* è¦ª(thumbnail-container)ã®100%ã®é«˜ã•ã¨å¹…ã‚’å æœ‰ */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%; 
    display: block; 
    background-size: cover; 
    background-position: center center;
    background-repeat: no-repeat;
    /* min-height: 180px; â† å‰Šé™¤ */
}

/* â˜…æ­£æ–¹å½¢ã‚’ç¶­æŒã™ã‚‹ãƒˆãƒªãƒƒã‚¯ (ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯” 1:1) */
.thumbnail-container::after {
    content: "";
    display: block;
    padding-top: 100%; /* å¹…ã«å¯¾ã™ã‚‹é«˜ã•ã‚’100%ã«è¨­å®š */
}

.link-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 0px; background-color: rgba(0, 0, 0, 0.4); opacity: 0; transition: opacity 0.3s ease; z-index: 10; pointer-events: none; }
.work-card:hover .link-overlay { opacity: 1; pointer-events: auto; }
.overlay-button_p, .overlay-button_x { background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; cursor: pointer; text-decoration: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); }
.overlay-button_p { margin-left: 15px; }
.overlay-button_x { margin-right: 15px; }
.overlay-button_p img, .overlay-button_x img { width: 24px; height: 24px; }

/* --- é€šçŸ¥ã‚¹ã‚¿ã‚¤ãƒ« --- */
#notificationContainer { position: fixed; top: 20px; right: 20px; z-index: 1000;}
.notification { color: white; padding: 10px 20px; margin-bottom: 10px; border-radius: 4px; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateX(100%); box-shadow: 0 4px 8px rgba(0,0,0,0.2); min-width: 250px; font-size: 0.95em; }
.notification.show { opacity: 0.95; transform: translateX(0); }
.notification.error { background-color: #dc3545; }
.notification.success { background-color: #28a745; }
</style>
</head>
<body>

<div id="notificationContainer"></div>

<div class="gallery-section">

<div id="galleryHeader">
 <h2>ğŸ–¼ï¸çµµç”»</h2>
 <div id="sortButtons">
  <button onclick="sortGallery('date')">
   <span class="material-symbols-outlined">calendar_month</span>
  </button>
  <button onclick="sortGallery('score')">
   <span class="material-symbols-outlined">refresh</span>
  </button>
 </div>
</div>

<div class="gallery-grid" id="galleryContainer">
<p id="loadingStatus">date.jsonã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
</div>
</div>


<script>
// JSONæ§‹é€ : { id: "20251109", p_u: "...", x_u: "...", s_u: "...", tags: [], l: [{d, c}] }
let appData = { illustrations: [] };
let worksWithScore = [];

const ICON_P = "https://play-lh.googleusercontent.com/Ls9opXo6-wfEWmbBU8heJaFS8HwWydssWE1J3vexIGvkF-UJDqcW7ZMD8w6dQABfygONd4z3Yt4TfRDZAPYq=w240-h480-rw";
const ICON_X = "https://play-lh.googleusercontent.com/XyI6Hyz9AFg7E_joVzX2zh6CpWm9B2DG2JuEz5meCFVm4-wTKTnHgqbmg62iFKe4Gzca=w240-h480-rw";

// DOMè¦ç´ ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const loadingStatusElement = document.getElementById('loadingStatus');

// --- ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥é–¢æ•° (ç¶­æŒ) ---
function showNotification(message, type = 'success') {
const container = document.getElementById('notificationContainer');
if (!container) return;

const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.textContent = message;

container.appendChild(notification);

setTimeout(() => {
notification.classList.add('show');
}, 100);

setTimeout(() => {
notification.classList.remove('show');
setTimeout(() => {
notification.remove();
}, 500);
}, 5000);
}
// --------------------------

// --- ãƒ‡ãƒ¼ã‚¿å‡¦ç†/ã‚½ãƒ¼ãƒˆã«å¿…è¦ãªé–¢æ•° (ç¶­æŒ) ---
function getDateFromId(id) {
if (id && id.match(/^\d{8}$/)) {
const datePart = id.substring(0, 8);
return `${datePart.substring(0, 4)}-${datePart.substring(4, 6)}-${datePart.substring(6, 8)}`;
}
if (id && id.match(/^\d{10}$/)) {
const datePart = id.substring(0, 8);
return `${datePart.substring(0, 4)}-${datePart.substring(4, 6)}-${datePart.substring(6, 8)}`;
}
return getFormattedDate();
}

function normalizeWorkData(item) {
if (item.likes_history) {
item.l = item.likes_history.map(h => ({ d: h.liked_date, c: h.count }));
delete item.likes_history;
}
  if (item.l) {
    item.l = item.l.map(h => {
      const { e, ...rest } = h;
      return rest;
    });
  }

if (!item.s_u && item.x_u) {
item.s_u = item.x_u;
}
return item;
}

function getFormattedDate(d = new Date()) { return d.toISOString().split('T')[0]; }
function getElapsedDays(d1, d2) { return Math.max(0, Math.ceil((new Date(d2) - new Date(d1)) / (1000 * 60 * 60 * 24))); }
function getMultiplier(days) { if (days >= 365) return 4; if (days >= 181) return 3; if (days >= 91) return 2; if (days >= 31) return 1.5; return 1; }

document.addEventListener('DOMContentLoaded', async () => {
    // loadingStatusElementã¯DOMãŒæ§‹ç¯‰ã•ã‚ŒãŸå¾Œã«ç¢ºå®Ÿã«å–å¾—ã•ã‚Œã‚‹
    await loadDateJSON();
});

/**
* date.jsonã‚’å¤–éƒ¨ã‹ã‚‰fetchã§èª­ã¿è¾¼ã‚€å‡¦ç†
*/
async function loadDateJSON() {
    const statusElement = loadingStatusElement;
    if (!statusElement) return; 

    try {
        const res = await fetch('date.json');
        if (!res.ok) throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${res.status}`);
        let rawData = await res.json();

        if (rawData && rawData.illustrations && Array.isArray(rawData.illustrations)) {
            rawData = rawData.illustrations;
        } else if (!Array.isArray(rawData)) {
            throw new Error('JSONãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒä¸æ­£ã§ã™ã€‚');
        }

        appData.illustrations = rawData.map(item => normalizeWorkData(item));

        calculateWorkScores();
        sortGallery('score', true);

        statusElement.textContent = `date.json (${appData.illustrations.length}ä»¶ã®ä½œå“) ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`;

    } catch (err) {
        console.error("JSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
        statusElement.textContent = 'date.jsonã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ç©ºã®ãƒ‡ãƒ¼ã‚¿ã§é–‹å§‹ã—ã¾ã™ã€‚';

        appData.illustrations = [];
        worksWithScore = [];
        renderGallery();
    }
}


function calculateWorkScores() {
    worksWithScore = appData.illustrations.map(w => {
        const postedDate = getDateFromId(w.id);
        
        const totalScore = (w.l || []).reduce((s, h) => {
            const days = getElapsedDays(postedDate, h.d);
            return s + (h.c * getMultiplier(days));
        }, 0);

        const totalLikes = (w.l || []).reduce((s, h) => s + h.c, 0);
        const lastLikedDate = (w.l || []).length > 0
            ? (w.l || []).map(h => h.d).sort().pop()
            : 'â€”';

        return {
            ...w,
            totalScore: totalScore,
            totalLikes: totalLikes,
            lastLikedDate: lastLikedDate
        };
    });
}

/**
* ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®ã‚½ãƒ¼ãƒˆã¨æç”»ã‚’è¡Œã†
*/
function sortGallery(sortBy, silent = false) {
    if (worksWithScore.length === 0) {
        renderGallery();
        return;
    }

    let sortedWorks = [...worksWithScore];

    if (sortBy === 'date') {
        // æ—¥ä»˜é™é † (æ–°ã—ã„ã‚‚ã®ãŒå…ˆ)
        sortedWorks.sort((a, b) => new Date(getDateFromId(b.id)) - new Date(getDateFromId(a.id)));
    } else { // 'score' (ãƒªã‚»ãƒƒãƒˆ)
        // ã‚¹ã‚³ã‚¢é™é † (é«˜ã„ã‚‚ã®ãŒå…ˆ)
        sortedWorks.sort((a, b) => b.totalScore - a.totalScore);
    }

    renderGallery(sortedWorks);
}

function renderGallery(works = []) {
    const c = document.getElementById('galleryContainer');
    c.innerHTML = '';

    if (works.length === 0) {
        c.innerHTML = '<p>ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }

    works.forEach((w) => {
        const postedDate = getDateFromId(w.id);

        const cardTitle = `ID: ${w.id}\nã‚¿ã‚°: ${(w.tags || []).join(', ')}\nâ™¥: ${w.totalLikes}\nå‰å›: ${w.lastLikedDate}\nã‚¹ã‚³ã‚¢: ${w.totalScore.toFixed(1)}\næŠ•ç¨¿æ—¥: ${postedDate}`;

        const card = document.createElement('div');
        card.className = 'work-card';
        card.title = cardTitle;

        card.innerHTML = `
        <div class="thumbnail-container">
        <div class="thumbnail-image"
        style="background-image: url('${w.s_u}');">
        </div>
        <div class="link-overlay">
        <a href="${w.p_u}" target="_blank" class="overlay-button_p">
        <img src="${ICON_P}" alt="Pixiv">
        </a>
        <a href="${w.x_u}" target="_blank" class="overlay-button_x">
        <img src="${ICON_X}" alt="X">
        </a>
        </div>
        </div>
        `;
        c.appendChild(card);
    });
}
</script>
</body>
</html>
