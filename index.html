<!DOCTYPE html>
<html lang="ja">
<head>
    <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/ fb# website: http://ogp.me/ns/ website#">
<meta property="og:url" content="https://sakazukiaoi.github.io/HIC_SHI_gallery/" />
<meta property="og:type" content="website" /> 
<meta property="og:title" content="Gallery" /> 
<meta property="og:description" content="" /> 
<meta property="og:site_name" content="HIC_SHI" /> 
<meta property="og:image" content="https://pbs.twimg.com/media/G6IaDdAbYAAXHK4?format=jpg" />
<link rel="icon" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png" sizes="180x180">
    
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>イラストギャラリー</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<style>
body {font-family: sans-serif;margin: 20px;background-color: #f4f4f4;color: #ffffff;}
h1 {display: none;}
h2 {border-bottom: 2px solid #ffffff;padding-bottom: 5px;margin-top: 0;}
.gallery-section {margin-bottom: 4px;padding: 2px;}

.material-symbols-outlined {
font-variation-settings:
'FILL' 0,
'wght' 400,
'GRAD' 0,
'opsz' 24;
font-family: 'Material Symbols Outlined';
font-weight: normal;
font-style: normal;
font-size: 24px;
line-height: 1;
letter-spacing: normal;
text-transform: none;
display: inline-block;
white-space: nowrap;
word-wrap: normal;
direction: ltr;
-webkit-font-feature-settings: "liga";
-webkit-font-smoothing: antialiased;
}

#galleryHeader {
display: flex;
align-items: center;
margin-bottom: 15px;
/* ボタンコンテナが全幅を使用するため、headerの高さをボタンに合わせる */
padding: 0; 
}
#galleryHeader h2 {
margin: 0;
margin-right: 15px;
border-bottom: none;
padding-bottom: 0;
}

/* UIボタン全体を格納するコンテナ */
#controlContainer {
    display: flex;
    gap: 15px; 
    align-items: center;
    /* 修正: 横一列を強制し、折り返さない */
    flex-wrap: nowrap; 
    /* 画面幅を超えた場合に横スクロールを許可 */
    overflow-x: auto; 
    /* スクロールバーを見せないように padding: 0 を適用 */
    padding: 10px 0; 
    width: 100%; /* 親要素の幅全体を使用 */
}

/* ソート基準ボタンとソート順ボタンのグループ */
#sortGroup {
    display: flex;
    gap: 10px;
    /* 横並びを維持 */
    flex-shrink: 0; 
}

/* アクションボタン（フィルター、リセット）のグループ */
#actionButtons {
    display: flex;
    gap: 10px; 
    /* 横並びを維持 */
    flex-shrink: 0;
}

/* ソートボタン（基準と順序）の基本スタイル */
#sortGroup button {
    background-color: #e2e6ea;
    color: rgb(0, 0, 0); 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 6px 10px;
    font-size: 0.9em;
    height: 35px;
    transition: background-color 0.2s;
}
#sortGroup button:hover {
    background-color: #0091ff;
}

/* アクションボタン（フィルター、リセット）の基本スタイル */
#actionButtons button {
    background-color: #f8f9fa;
    color: #000000; 
    border: 1px solid #ced4da; 
    border-radius: 4px; 
    cursor: pointer; 
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 6px 10px;
    font-size: 0.9em;
    height: 35px;
    transition: background-color 0.2s, border-color 0.2s;
}

/* リセットボタンのスタイル */
#resetButton {
    background-color: #dc3545;
    color: white;
    border-color: #dc3545;
}
#resetButton:hover {
    background-color: #ffffff;
    border-color: #000000;
}

/* フィルターボタンの状態 */
.filter-active { /* 状態 1: ON (緑) */
    background-color: #28a745 !important;
    color: white !important;
    border-color: #28a745 !important;
}
.filter-active:hover {
    background-color: #74abff !important;
}

.filter-inverse { /* 状態 2: ✕ (青) */
    background-color: #4689d1 !important;
    color: rgb(255, 255, 255) !important;
    border-color: #778492 !important;
}
.filter-inverse:hover {
    background-color: #d6d6d6!important;
}

/* ソートボタンのアクティブ状態 */
.sort-active {
    background-color: #e2e6ea !important;
}
.sort-active:hover {
    background-color: #0091ff!important;
}


.gallery-grid {
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
    grid-auto-rows: 6px;
    grid-gap: 3px; 
    padding: 0 1px;
    align-items: start;
}

@media (max-width: 900px) {
.gallery-grid {
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
}
}
@media (max-width: 600px) {
.gallery-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
}
}


.work-card {
border: 1px solid #ddd;
padding: 0;
background-color: #fff;
box-shadow: 0 0 5px rgba(0,0,0,0.1);
position: relative;
overflow: hidden; 
box-sizing: border-box; 
}

.thumbnail-container { 
width: 100%; 
height: auto; 
position: relative; 
overflow: hidden; 
margin-bottom: 0; 
display: block; 
}

.thumbnail-container img.thumbnail-img { 
width: 100%; 
height: auto; 
display: block; 
}

.thumbnail-image { display: none; }
.thumbnail-container::after { content: ""; display: none; }
.link-overlay, .overlay-button_p, .overlay-button_x { display: none !important; }

</style>
</head>
<body>

<div id="notificationContainer"></div>

<div class="gallery-section">

<div id="galleryHeader">

<div id="controlContainer">
    <div id="sortGroup">
        <button id="sortTypeButton" onclick="changeState('SORT_TYPE')">
            <span class="material-symbols-outlined">sort</span>
            <span id="sortTypeText"></span>
        </button>
        <button id="sortOrderButton" onclick="changeState('SORT_ORDER')">
            <span class="material-symbols-outlined">arrow_downward</span>
        </button>
    </div>
    
    <div id="actionButtons">
        <button id="resetButton" onclick="changeState('RESET')">
            <span class="material-symbols-outlined">restart_alt</span>
            <span></span>
        </button>
        <button id="originalFilterButton" onclick="changeState('FILTER')">
            <span id="filterStatusText">オリジナル</span>
        </button>

    </div>
</div>
</div>

<div class="gallery-grid" id="galleryContainer">
<p id="loadingStatus">date.jsonを読み込んでいます...</p>
</div>
</div>


<script>
// JSON構造: { id: "20251109", p_u: "...", x_u: "...", s_u: "...", tags: [], l: [{d, c}] }
let appData = { illustrations: [] };
let worksWithScore = [];

// ギャラリーの状態を保持
let galleryState = {
    sortType: 'score', // 'score' | 'date'
    sortOrder: 'desc', // 'desc' | 'asc'
    filterState: 0     // 0: OFF, 1: ON, 2: ✕
};

const loadingStatusElement = document.getElementById('loadingStatus');
const galleryContainerElement = document.getElementById('galleryContainer');
const sortTypeButton = document.getElementById('sortTypeButton');
const sortTypeText = document.getElementById('sortTypeText');
const sortOrderButton = document.getElementById('sortOrderButton');
const originalFilterButton = document.getElementById('originalFilterButton');
const filterStatusText = document.getElementById('filterStatusText');


function getDateFromId(id) {
if (id && id.match(/^\d{8}$/)) {
const datePart = id.substring(0, 8);
return `${datePart.substring(0, 4)}-${datePart.substring(4, 6)}-${datePart.substring(6, 8)}`;
}
if (id && id.match(/^\d{10}$/)) {
const datePart = id.substring(0, 8);
return `${datePart.substring(0, 4)}-${datePart.substring(4, 6)}-${datePart.substring(6, 8)}`;
}
return getFormattedDate();
}

function normalizeWorkData(item) {
if (item.likes_history) {
item.l = item.likes_history.map(h => ({ d: h.liked_date, c: h.count }));
delete item.likes_history;
}
if (item.l) {
 item.l = item.l.map(h => {
 const { e, ...rest } = h;
 return rest;
 });
}

if (!item.s_u && item.x_u) {
item.s_u = item.x_u;
}
if (!item.tags) {
 item.tags = [];
}
return item;
}

function getFormattedDate(d = new Date()) { return d.toISOString().split('T')[0]; }
function getElapsedDays(d1, d2) { return Math.max(0, Math.ceil((new Date(d2) - new Date(d1)) / (1000 * 60 * 60 * 24))); }
function getMultiplier(days) { if (days >= 365) return 4; if (days >= 181) return 3; if (days >= 91) return 2; if (days >= 31) return 1.5; return 1; }

document.addEventListener('DOMContentLoaded', async () => {
 await loadDateJSON();
});

async function loadDateJSON() {
  const statusElement = loadingStatusElement;
  if (!statusElement) return; 

  try {
    const res = await fetch('date.json');
    
    if (!res.ok) throw new Error(`HTTPエラー: ${res.status}`);
    
    let rawData = await res.json();

    if (rawData && rawData.illustrations && Array.isArray(rawData.illustrations)) {
      rawData = rawData.illustrations;
    } else if (!Array.isArray(rawData)) {
      throw new Error('JSONファイル形式が不正です。');
    }

    appData.illustrations = rawData.map(item => normalizeWorkData(item));

    calculateWorkScores();
    // 初期状態 (スコア順 降順 フィルターOFF) でUIとギャラリーを更新
    updateUI();
    sortGallery();

    statusElement.textContent = `date.json (${appData.illustrations.length}件の作品) を読み込みました。`;

  } catch (err) {
    console.error("JSON読み込みエラー:", err);
    statusElement.textContent = `エラー: ${err.message || 'date.jsonを読み込めませんでした。空のデータで開始します。'}`;

    appData.illustrations = [];
    worksWithScore = [];
    updateUI();
    renderGallery();
  }
}


function calculateWorkScores() {
  worksWithScore = appData.illustrations.map(w => {
    const postedDate = getDateFromId(w.id);
    
    const totalScore = (w.l || []).reduce((s, h) => {
      const days = getElapsedDays(postedDate, h.d);
      return s + (h.c * getMultiplier(days));
    }, 0);

    const totalLikes = (w.l || []).reduce((s, h) => s + h.c, 0);
    const lastLikedDate = (w.l || []).length > 0
      ? (w.l || []).map(h => h.d).sort().pop()
      : '—';

    return {
      ...w,
      totalScore: totalScore,
      totalLikes: totalLikes,
      lastLikedDate: lastLikedDate
    };
  });
}

function updateUI() {
    // 1. ソート基準ボタンの更新
    if (galleryState.sortType === 'score') {
        sortTypeText.textContent = 's';
        sortTypeButton.classList.add('sort-active');
    } else {
        sortTypeText.textContent = 'd';
        sortTypeButton.classList.remove('sort-active');
    }

    // 2. ソート順ボタンの更新
    if (galleryState.sortOrder === 'desc') {
        sortOrderButton.innerHTML = '<span class="material-symbols-outlined">arrow_downward</span>';
        sortOrderButton.classList.add('sort-active');
    } else {
        sortOrderButton.innerHTML = '<span class="material-symbols-outlined">arrow_upward</span>';
        sortOrderButton.classList.remove('sort-active');
    }

    // 3. フィルターボタンの更新
    originalFilterButton.classList.remove('filter-active', 'filter-inverse');
    
    if (galleryState.filterState === 1) {
        originalFilterButton.classList.add('filter-active');
        filterStatusText.textContent = 'オリジナル';
    } else if (galleryState.filterState === 2) {
        originalFilterButton.classList.add('filter-inverse');
        filterStatusText.textContent = 'オリジナル✕';
    } else {
        filterStatusText.textContent = 'オリジナル';
    }
}

// 状態遷移ロジックを実装するコア関数
function changeState(action) {
    let { sortType, sortOrder, filterState } = galleryState;
    let newState = { ...galleryState };
    
    // 現在の状態を定義
    // 'score_desc_0' (初期), 'score_asc_0' (⑬), 'date_desc_0' (⓪), 'date_asc_0' (⑮)
    // 'score_desc_1' (①), 'score_asc_1' (⑰), 'date_desc_1' (②), 'date_asc_1' (⑲)
    // 'score_desc_2' (⑧), 'score_asc_2' (㉓), 'date_desc_2' (④), 'date_asc_2' (㉑)
    const currentStateKey = `${sortType}_${sortOrder}_${filterState}`;

    let nextState;

    // --- 状態遷移ロジック (要件5) ---
    if (action === 'RESET') {
        // ③, ⑥, ⑨, ⑫ 全て初期状態へ
        newState = { sortType: 'score', sortOrder: 'desc', filterState: 0 };
    } 
    else if (action === 'SORT_TYPE') {
        // ソート基準の切り替え (score <-> date)
        nextState = sortType === 'score' ? 'date' : 'score';

        if (currentStateKey === 'score_desc_0') { // 初期 -> ⓪
            newState = { sortType: 'date', sortOrder: 'desc', filterState: 0 };
        } else if (currentStateKey === 'score_asc_0') { // ⑬ -> ⑮
            newState = { sortType: 'date', sortOrder: 'asc', filterState: 0 };
        } else if (currentStateKey === 'date_desc_0') { // ⓪ -> 初期
            newState = { sortType: 'score', sortOrder: 'desc', filterState: 0 };
        } else if (currentStateKey === 'date_asc_0') { // ⑮ -> ⑬
            newState = { sortType: 'score', sortOrder: 'asc', filterState: 0 };
        }
        
        else if (currentStateKey === 'score_desc_1') { // ① -> ②
            newState = { sortType: 'date', sortOrder: 'desc', filterState: 1 };
        } else if (currentStateKey === 'score_asc_1') { // ⑰ -> ⑲
            newState = { sortType: 'date', sortOrder: 'asc', filterState: 1 };
        } else if (currentStateKey === 'date_desc_1') { // ② -> ⑤ (①へ)
            newState = { sortType: 'score', sortOrder: 'desc', filterState: 1 };
        } else if (currentStateKey === 'date_asc_1') { // ⑲ -> ㉗ (⑰へ)
            newState = { sortType: 'score', sortOrder: 'asc', filterState: 1 };
        }
        
        else if (currentStateKey === 'score_desc_2') { // ⑧ -> ⑪ (④へ)
            newState = { sortType: 'date', sortOrder: 'desc', filterState: 2 };
        } else if (currentStateKey === 'score_asc_2') { // ㉓ -> ㉗ (㉑へ)
            newState = { sortType: 'date', sortOrder: 'asc', filterState: 2 };
        } else if (currentStateKey === 'date_desc_2') { // ④ -> ⑤ (⑧へ)
            newState = { sortType: 'score', sortOrder: 'desc', filterState: 2 };
        } else if (currentStateKey === 'date_asc_2') { // ㉑ -> ㉗ (㉓へ)
            newState = { sortType: 'score', sortOrder: 'asc', filterState: 2 };
        }

    } 
    else if (action === 'SORT_ORDER') {
        // ソート順の切り替え (desc <-> asc)
        nextState = sortOrder === 'desc' ? 'asc' : 'desc';

        if (currentStateKey === 'score_desc_0') { // 初期 -> ⑬
            newState = { sortType: 'score', sortOrder: 'asc', filterState: 0 };
        } else if (currentStateKey === 'score_asc_0') { // ⑬ -> 初期
            newState = { sortType: 'score', sortOrder: 'desc', filterState: 0 };
        } else if (currentStateKey === 'date_desc_0') { // ⓪ -> ⑮
            newState = { sortType: 'date', sortOrder: 'asc', filterState: 0 };
        } else if (currentStateKey === 'date_asc_0') { // ⑮ -> ⓪
            newState = { sortType: 'date', sortOrder: 'desc', filterState: 0 };
        }
        
        else if (currentStateKey === 'score_desc_1') { // ① -> ⑰
            newState = { sortType: 'score', sortOrder: 'asc', filterState: 1 };
        } else if (currentStateKey === 'score_asc_1') { // ⑰ -> ①
            newState = { sortType: 'score', sortOrder: 'desc', filterState: 1 };
        } else if (currentStateKey === 'date_desc_1') { // ② -> ⑲
            newState = { sortType: 'date', sortOrder: 'asc', filterState: 1 };
        } else if (currentStateKey === 'date_asc_1') { // ⑲ -> ②
            newState = { sortType: 'date', sortOrder: 'desc', filterState: 1 };
        }
        
        else if (currentStateKey === 'score_desc_2') { // ⑧ -> ㉓
            newState = { sortType: 'score', sortOrder: 'asc', filterState: 2 };
        } else if (currentStateKey === 'score_asc_2') { // ㉓ -> ⑧
            newState = { sortType: 'score', sortOrder: 'desc', filterState: 2 };
        } else if (currentStateKey === 'date_desc_2') { // ④ -> ㉑
            newState = { sortType: 'date', sortOrder: 'asc', filterState: 2 };
        } else if (currentStateKey === 'date_asc_2') { // ㉑ -> ④
            newState = { sortType: 'date', sortOrder: 'desc', filterState: 2 };
        }
    } 
    else if (action === 'FILTER') {
        // フィルター状態の変更 (0 -> 1 -> 2 -> 0)
        
        if (filterState === 0) { // OFF -> ON
            newState.filterState = 1;

            if (currentStateKey === 'score_desc_0') { // 初期 -> ①
                // スコア順、降順、ON (①)
            } else if (currentStateKey === 'score_asc_0') { // ⑬ -> ㉘ (⑰へ)
                newState.filterState = 1;
            } else if (currentStateKey === 'date_desc_0') { // ⓪ -> ②
                newState = { sortType: 'date', sortOrder: 'desc', filterState: 1 };
            } else if (currentStateKey === 'date_asc_0') { // ⑮ -> ㉙ (⑲へ)
                newState.filterState = 1;
            }

            else if (currentStateKey === 'score_desc_2') { // ⑧ -> ⑩ (初期へ)
                newState = { sortType: 'score', sortOrder: 'desc', filterState: 0 };
            } else if (currentStateKey === 'score_asc_2') { // ㉓ -> ㉖ (⑬へ)
                newState = { sortType: 'score', sortOrder: 'asc', filterState: 0 };
            } else if (currentStateKey === 'date_desc_2') { // ④ -> ⑦ (⓪へ)
                newState = { sortType: 'date', sortOrder: 'desc', filterState: 0 };
            } else if (currentStateKey === 'date_asc_2') { // ㉑ -> ㉕ (⑮へ)
                newState = { sortType: 'date', sortOrder: 'asc', filterState: 0 };
            }

        } else if (filterState === 1) { // ON -> ✕
            newState.filterState = 2;

            if (currentStateKey === 'score_desc_1') { // ① -> ⑧
                newState = { sortType: 'score', sortOrder: 'desc', filterState: 2 };
            } else if (currentStateKey === 'score_asc_1') { // ⑰ -> ㉗ (㉓へ)
                newState = { sortType: 'score', sortOrder: 'asc', filterState: 2 };
            } else if (currentStateKey === 'date_desc_1') { // ② -> ④
                newState = { sortType: 'date', sortOrder: 'desc', filterState: 2 };
            } else if (currentStateKey === 'date_asc_1') { // ⑲ -> ㉚ (㉑へ)
                newState = { sortType: 'date', sortOrder: 'asc', filterState: 2 };
            }
        } else if (filterState === 2) { // ✕ -> OFF
            newState.filterState = 0;
            // フィルターOFFへ移行する際、ソート基準/順序は維持される
        }
    }

    // 状態を更新
    galleryState = newState;
    
    // UIを更新してギャラリーを再描画
    updateUI();
    sortGallery();
}


function sortGallery() {
  const { sortType, sortOrder, filterState } = galleryState;

  // フィルターを適用
  let filteredWorks = worksWithScore.filter(work => {
    const hasOriginalTag = (work.tags || []).includes('オリジナル');

    if (filterState === 1) {
      // 状態 1: オリジナルのみ
      return hasOriginalTag;
    } else if (filterState === 2) {
      // 状態 2: オリジナル以外 (✕)
      return !hasOriginalTag;
    } else {
      // 状態 0: フィルター OFF (全て表示)
      return true;
    }
  });

  if (filteredWorks.length === 0) {
    renderGallery([]);
    return;
  }

  let sortedWorks = [...filteredWorks];

  // ソートを適用
  sortedWorks.sort((a, b) => {
    let valA, valB;
    
    if (sortType === 'date') {
        // 日付順
        valA = new Date(getDateFromId(a.id)).getTime();
        valB = new Date(getDateFromId(b.id)).getTime();
    } else {
        // スコア順
        valA = a.totalScore;
        valB = b.totalScore;
    }
    
    if (sortOrder === 'desc') {
        return valB - valA;
    } else {
        return valA - valB;
    }
  });

  renderGallery(sortedWorks);
}

function renderGallery(works = []) {
  const c = galleryContainerElement;
  c.innerHTML = '';

  if (works.length === 0) {
    if (galleryState.filterState !== 0) {
      c.innerHTML = '<p>現在のフィルター条件に一致する作品はありません。</p>';
    } else {
      c.innerHTML = '<p>作品がありません。</p>';
    }
    return;
  }
  
  const rowHeight = 10; 

  works.forEach((w) => {
    const postedDate = getDateFromId(w.id);
    const cardTitle = `投稿日: ${postedDate}\nタグ: ${(w.tags || []).join(', ')}`;

    const card = document.createElement('div');
    card.className = 'work-card';
    card.title = cardTitle;

    card.innerHTML = `
    <div class="thumbnail-container">
      <img src="${w.s_u}" alt="作品" class="thumbnail-img">
    </div>
    `;
    
    card.style.gridRowEnd = `span 1`; 
    c.appendChild(card);

    const imgElement = card.querySelector('.thumbnail-img');

    const adjustCardHeight = () => {
      const actualCardHeight = card.clientHeight; 
      
      const requiredGridHeight = actualCardHeight + 10; 

      let spanRows = Math.ceil(requiredGridHeight / rowHeight);

      spanRows = Math.max(spanRows, 1); 
      
      card.style.gridRowEnd = `span ${spanRows}`;
    };

    imgElement.onload = adjustCardHeight;
    imgElement.onerror = () => {
      console.error(`画像のロードに失敗しました: ${w.s_u}`);
      card.style.gridRowEnd = `span 20`; 
    };

    if (imgElement.complete) {
      adjustCardHeight();
    }
  });
}
</script>
</body>
</html>
