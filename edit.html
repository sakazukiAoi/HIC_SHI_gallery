<!DOCTYPE html>
<html lang="ja">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¤ãƒ©ã‚¹ãƒˆæ´»å‹•ãƒ­ã‚°ï¼†è©•ä¾¡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<style>
body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
h1 { border-bottom: 3px double #333; padding-bottom: 10px; }
h2 { border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-top: 30px; }
.form-section, .gallery-section { margin-bottom: 40px; padding: 20px; border: 1px solid #eee; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
#dataManagementSection { background-color: #fffbe6; border-color: #ffeb3b; }
.gallery-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
gap: 20px;
}
.work-card {
border: 1px solid #ddd;
padding: 10px;
background-color: #fff;
box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
/* ç›¸å¯¾ä½ç½®æŒ‡å®šã‚’æœ‰åŠ¹ã«ã—ã€ãƒ›ãƒãƒ¼æ¤œå‡ºé ˜åŸŸã¨ã™ã‚‹ */
position: relative;
}

/* --- ã‚µãƒ ãƒã‚¤ãƒ«çµ±ä¸€ã®ãŸã‚ã®CSS --- */
.thumbnail-container {
width: 100%;
padding-top: 46.626%; /* 778 / 1669 * 100% */
position: relative;
overflow: hidden;
margin-bottom: 10px;
}
.thumbnail-image {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-size: cover;
background-position: center center;
background-repeat: no-repeat;
}
/* ------------------------------- */

/* --- ãƒ›ãƒãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®CSS --- */
.link-overlay {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
display: flex;
/* ãƒœã‚¿ãƒ³ã‚’ä¸¡ç«¯ã«é…ç½® */
justify-content: space-between;
align-items: center;
/* å·¦å³ç«¯ã«ãƒœã‚¿ãƒ³ã‚’é…ç½®ã™ã‚‹ãŸã‚ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¯0 */
padding: 0 0px;
background-color: rgba(0, 0, 0, 0.4); /* èƒŒæ™¯ã‚’å°‘ã—æš—ãã™ã‚‹ */
opacity: 0; /* é€šå¸¸ã¯éè¡¨ç¤º */
transition: opacity 0.3s ease;
z-index: 10;
pointer-events: none; /* ãƒ›ãƒãƒ¼ã‚¨ãƒªã‚¢ãŒãƒœã‚¿ãƒ³ã®ä¸‹ã«ã‚ã‚‹è¦ç´ ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ã‚ˆã†ã«ã™ã‚‹ */
}
/* work-cardã«ãƒ›ãƒãƒ¼ã—ãŸã¨ãã«è¡¨ç¤º */
.work-card:hover .link-overlay {
opacity: 1;
pointer-events: auto; /* ãƒ›ãƒãƒ¼æ™‚ã®ã¿ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
}
.overlay-button_p {
background: rgba(255, 255, 255, 0.9);
border: none;
border-radius: 50%;
width: 40px;
height: 40px;
display: flex;
justify-content: center;
align-items: center;
cursor: pointer;
text-decoration: none;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
/* 1669ã®åŠåˆ†ã®åŠåˆ† (25%) â‰’ 25% * 220px/2 = 27.5px ã®ãƒãƒ¼ã‚¸ãƒ³ */
margin-left: 28px;
}

.overlay-button_x {
background: rgba(255, 255, 255, 0.9);
border: none;
border-radius: 50%;
width: 40px;
height: 40px;
display: flex;
justify-content: center;
align-items: center;
cursor: pointer;
text-decoration: none;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
/* 1669ã®åŠåˆ†ã®åŠåˆ† (25%) â‰’ 25% * 220px/2 = 27.5px ã®ãƒãƒ¼ã‚¸ãƒ³ */
margin-right: 30px;
}
.overlay-button_p img {
width: 24px;
height: 24px;
}
.overlay-button_x img {
width: 24px;
height: 24px;
}
/* --- ãƒ›ãƒãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®CSSã“ã“ã¾ã§ --- */


#likeInputContainer { border: 1px dashed #ccc; padding: 15px; margin-top: 10px; background-color: #fcfcfc; }

/* â˜… ã„ã„ã­å…¥åŠ›ä¸€è¦§ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.like-item {
display: flex;
align-items: center;
padding: 5px 0;
border-bottom: 1px dotted #eee;
justify-content: space-between;
}
.like-item:last-child {
border-bottom: none;
}
.like-thumbnail {
width: 60px;
height: 60px;
background-size: cover;
background-position: center center;
margin-right: 10px;
flex-shrink: 0;
}
.like-info {
flex-grow: 1;
font-size: 0.9em;
color: #555;
line-height: 1.2;
display: flex;
flex-direction: column;
}
.like-info-top {
    display: flex;
    align-items: center;
    margin-bottom: 2px;
}
.like-current-count {
    font-size: 0.85em;
    font-weight: bold;
    color: #dc3545; 
    margin-left: 10px;
    padding: 2px 5px;
    border-radius: 3px;
    background-color: #ffe0e3;
}

.like-info span {
font-weight: bold;
color: #333;
}
.like-controls {
display: flex;
align-items: center;
flex-shrink: 0;
margin-right: 80%;
}
.like-controls button {
width: 30px;
height: 30px;
padding: 0;
line-height: 1;
font-size: 1.2em;
margin: 0 5px;
background-color: #6c757d;
}
.like-controls button:hover {
background-color: #495057;
}
.like-count {
width: 40px;
text-align: center;
font-weight: bold;
font-size: 1.1em;
}
/* â˜… ã‚¹ã‚¿ã‚¤ãƒ«çµ‚ã‚ã‚Š */

input, select, textarea { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; background-color: #007bff; color: white; transition: background-color 0.3s; }
button:hover { background-color: #0056b3; }
#likeForm button:last-child { background-color: #28a745; }
#likeForm button:last-child:hover { background-color: #1e7e34; }
.analysis-section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; background-color: #f9f9f9; }
.analysis-section ul { list-style: none; padding-left: 0; }
.analysis-section li { margin-bottom: 5px; }

/* --- ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
#notificationContainer {
position: fixed;
top: 20px;
right: 20px;
z-index: 1000;
}
.notification {
color: white;
padding: 10px 20px;
margin-bottom: 10px;
border-radius: 4px;
opacity: 0;
transition: opacity 0.5s, transform 0.5s;
transform: translateX(100%);
box-shadow: 0 4px 8px rgba(0,0,0,0.2);
min-width: 250px;
font-size: 0.95em;
}
.notification.show {
opacity: 0.95;
transform: translateX(0);
}
.notification.error {
background-color: #dc3545; /* èµ¤è‰²ã§ã‚¨ãƒ©ãƒ¼ã‚’å¼·èª¿ */
}
.notification.success {
background-color: #28a745; /* ç·‘è‰²ã§æˆåŠŸã‚’å¼·èª¿ */
}
/* -------------------------------------- */
</style>
</head>
<body>

<div id="notificationContainer"></div>

<h1>ã‚¤ãƒ©ã‚¹ãƒˆæ´»å‹•ãƒ­ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

<div class="form-section">
<h2>âœï¸ æ´»å‹•ã®è¨˜éŒ²</h2>
<p>è¨˜éŒ²æ—¥: <span id="currentDate"></span></p>

<label for="recordType">è¨˜éŒ²ã®ç¨®é¡:</label>
<select id="recordType" onchange="toggleRecordForm(this.value)">
<option value="post">æ–°è¦æŠ•ç¨¿ä½œå“ã®è¨˜éŒ²</option>
<option value="like">éå»ä½œã¸ã®ã„ã„ã­è¨˜éŒ²</option>
</select>

<div id="postForm" style="display:block; margin-top:15px;">
<p><strong>[æ–°è¦æŠ•ç¨¿]</strong> ä½œå“æƒ…å ±</p>
<label for="postPixivUrl">Pixiv URL:</label>
<input type="url" id="postPixivUrl" placeholder="Pixivä½œå“ã®URL" required style="width: 80%;"><br><br>
<label for="postXUrl">X URL:</label>
<input type="url" id="postXUrl" placeholder="Xãƒã‚¹ãƒˆURL" required style="width: 80%;"><br><br>
<label for="postThumbnailUrl">ã‚µãƒ ãƒ:</label>
<input type="url" id="postThumbnailUrl" placeholder="ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºç”¨ã®Xãƒã‚¹ãƒˆURL" required style="width: 80%;"><br><br>

<label for="postTags">ã‚¿ã‚° ã‚ªãƒªã‚¸ãƒŠãƒ«, ã‚¤ãƒ©ã‚¹ãƒˆ, å‰µä½œ:</label>
<input type="text" id="postTags" placeholder="å‰µä½œ, å¥³ã®å­, ã‚ªãƒªã‚¸ãƒŠãƒ«" style="width: 80%;"><br><br>

<button onclick="recordNewPost()">æ–°è¦æŠ•ç¨¿ã‚’è¨˜éŒ²</button>
</div>

<div id="likeForm" style="display:none; margin-top:15px;">
<p><strong>[éå»ä½œã„ã„ã­è¨˜éŒ²]</strong></p>
<div id="likeInputContainer">
    </div>
<button onclick="recordAllLikes()" style="margin-top: 10px;">æœ¬æ—¥åˆ†ã®ã„ã„ã­ã‚’è¨˜éŒ²</button>
</div>
</div>


<div class="gallery-section">
<h2>ğŸ–¼ï¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h2>
<div class="gallery-grid" id="galleryContainer">
<p id="loadingStatus">date.jsonã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
</div>

<h2>ğŸ“Š åˆ†æçµæœ</h2>
<div class="analysis-section" id="analysisSection">
<p>ä½œå“ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
</div>
</div>


<script>
// JSONæ§‹é€ : { id: "20251109", p_u: "...", x_u: "...", s_u: "...", tags: [], l: [{d, c}] }
let appData = { illustrations: [] };

// ã‚¢ã‚¤ã‚³ãƒ³URLã®å®šç¾©
const ICON_P = "https://play-lh.googleusercontent.com/Ls9opXo6-wfEWmbBU8heJaFS8HwWydssWE1J3vexIGvkF-UJDqcW7ZMD8w6dQABfygONd4z3Yt4TfRDZAPYq=w240-h480-rw";
const ICON_X = "https://play-lh.googleusercontent.com/XyI6Hyz9AFg7E_joVzX2zh6CpWm9B2DG2JuEz5meCFVm4-wTKTnHgqbmg62iFKe4Gzca=w240-h480-rw";

// --- ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ ---
function showNotification(message, type = 'success') {
const container = document.getElementById('notificationContainer');
if (!container) return;

const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.textContent = message;

container.appendChild(notification);

setTimeout(() => {
notification.classList.add('show');
}, 100);

setTimeout(() => {
notification.classList.remove('show');
setTimeout(() => {
notification.remove();
}, 500);
}, 5000);
}
// --------------------------

// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ä½œå“IDï¼ˆä¾‹: "20251109"ï¼‰ã‹ã‚‰æŠ•ç¨¿æ—¥ï¼ˆä¾‹: "2025-11-09"ï¼‰ã‚’å–å¾—
function getDateFromId(id) {
if (id && id.match(/^\d{8}$/)) {
const datePart = id.substring(0, 8);
return `${datePart.substring(0, 4)}-${datePart.substring(4, 6)}-${datePart.substring(6, 8)}`;
}
if (id && id.match(/^\d{10}$/)) {
const datePart = id.substring(0, 8);
return `${datePart.substring(0, 4)}-${datePart.substring(4, 6)}-${datePart.substring(6, 8)}`;
}
return getFormattedDate();
}

// å±¥æ­´ã®ã‚¿ã‚°ã‚’å†…éƒ¨å¤‰æ•°åï¼ˆlikes_historyï¼‰ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function normalizeWorkData(item) {
// éå»ã®å½¢å¼ (likes_history) ã®å ´åˆã¯ã€æ–°ã—ã„å½¢å¼ (l) ã«å¤‰æ›
if (item.likes_history) {
item.l = item.likes_history.map(h => ({
d: h.liked_date,
// e (elapsed_days) ã¯å‰Šé™¤ã—ã€dã‹ã‚‰è¨ˆç®—ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
c: h.count
}));
delete item.likes_history;
}
 // äº’æ›æ€§ã®ãŸã‚ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã«eãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿æŒã—ãªã„ãŸã‚ï¼‰
 if(item.l){
  item.l = item.l.map(h => {
   const { e, ...rest } = h; // eã‚’å‰Šé™¤
   return rest;
  });
 }

// éå»ã®å½¢å¼ã§ s_u ãŒãªã„å ´åˆã¯ x_u ã‚’ä½¿ç”¨ã™ã‚‹
if (!item.s_u && item.x_u) {
item.s_u = item.x_u;
}
return item;
}

function getFormattedDate(d = new Date()) { return d.toISOString().split('T')[0]; }
// æŠ•ç¨¿æ—¥ (d1) ã¨è¨˜éŒ²æ—¥ (d2) ã‹ã‚‰çµŒéæ—¥æ•°ã‚’è¨ˆç®—
function getElapsedDays(d1, d2) { return Math.max(0, Math.ceil((new Date(d2)-new Date(d1))/(1000*60*60*24))); }
// çµŒéæ—¥æ•°ã«åŸºã¥ã„ã¦ä¹—æ•°ã‚’å‹•çš„ã«è¨ˆç®—
function getMultiplier(days){ if(days>=365)return 4; if(days>=181)return 3; if(days>=91)return 2; if(days>=31)return 1.5; return 1; }

document.addEventListener('DOMContentLoaded', async () => {
document.getElementById('currentDate').textContent = getFormattedDate();
await loadDateJSON();
});

/**
* date.jsonã‚’å¤–éƒ¨ã‹ã‚‰fetchã§èª­ã¿è¾¼ã‚€å‡¦ç†
*/
async function loadDateJSON(){
try {
const res = await fetch('date.json');
if (!res.ok) throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${res.status}`);
let rawData = await res.json();

if (rawData && rawData.illustrations && Array.isArray(rawData.illustrations)) {
rawData = rawData.illustrations;
} else if (!Array.isArray(rawData)) {
throw new Error('JSONãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒä¸æ­£ã§ã™ã€‚');
}

// èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„å½¢å¼ã«æ­£è¦åŒ–
appData.illustrations = rawData.map(item => normalizeWorkData(item));

renderGallery();
document.getElementById('loadingStatus').textContent = `date.json (${appData.illustrations.length}ä»¶ã®ä½œå“) ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`;
} catch (err) {
console.error("JSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
document.getElementById('loadingStatus').textContent = 'date.jsonã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ç©ºã®ãƒ‡ãƒ¼ã‚¿ã§é–‹å§‹ã—ã¾ã™ã€‚';

appData.illustrations = [];
renderGallery();
}
}

function toggleRecordForm(v){
document.getElementById('postForm').style.display = v==='post'?'block':'none';
document.getElementById('likeForm').style.display = v==='like'?'block':'none';
if(v==='like') loadLikeInputs();
}

/**
 * ã„ã„ã­å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã€å…¨ä½œå“ã®ãƒªã‚¹ãƒˆå½¢å¼ã§æç”»ã™ã‚‹
 */
function loadLikeInputs(){
    const c=document.getElementById('likeInputContainer');
    c.innerHTML='';

    if(appData.illustrations.length===0){
        c.innerHTML='<p style="color:red;">ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°è¦æŠ•ç¨¿ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚</p>';
        return;
    }
    
    // --- ç´¯ç©ã„ã„ã­æ•°ã‚’è¨ˆç®— (ã“ã®é–¢æ•°å†…ã§å†åˆ©ç”¨ã™ã‚‹ãŸã‚) ---
    const workLikes = {};
    appData.illustrations.forEach(w => {
        workLikes[w.id] = (w.l || []).reduce((s, h) => s + h.c, 0);
    });
    // ---

    // æœ€æ–°æŠ•ç¨¿é †ã«ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
    const sortedWorks = [...appData.illustrations].sort((a,b) => new Date(getDateFromId(b.id)) - new Date(getDateFromId(a.id)));

    sortedWorks.forEach(w => {
        const postedDate = getDateFromId(w.id);
        const tagsDisplay = (w.tags || []).join(', ');
        const currentLikes = workLikes[w.id]; // ç´¯ç©ã„ã„ã­æ•°ã‚’å–å¾—

        const div = document.createElement('div');
        div.className = 'like-item';
        div.setAttribute('data-work-id', w.id);
        div.innerHTML = `
            <div class="like-thumbnail" style="background-image: url('${w.s_u}');"></div>
            <div class="like-info">
                <div class="like-info-top">
                    <span>${w.id}</span>
                    <span class="like-current-count">â™¥${currentLikes}</span>
                </div>
                ${tagsDisplay}
            </div>
            <div class="like-controls">
                <button onclick="changeLikeCount('${w.id}', -1)">ï¼</button>
                <span id="count_${w.id}" class="like-count" data-count="0">0</span>
                <button onclick="changeLikeCount('${w.id}', 1)">ï¼‹</button>
            </div>
        `;
        c.appendChild(div);
    });
}

/**
 * ã„ã„ã­æ•°ã‚’å¢—æ¸›ã•ã›ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 * @param {string} workId - ä½œå“ID
 * @param {number} delta - å¢—æ¸›å€¤ (+1 ã¾ãŸã¯ -1)
 */
function changeLikeCount(workId, delta) {
    const countElement = document.getElementById(`count_${workId}`);
    if (!countElement) return;

    let currentCount = parseInt(countElement.getAttribute('data-count'));
    let newCount = currentCount + delta;

    // 0æœªæº€ã«ã¯ã—ãªã„
    if (newCount < 0) newCount = 0;

    countElement.setAttribute('data-count', newCount);
    countElement.textContent = newCount;
}

function recordNewPost(){
const p=document.getElementById('postPixivUrl').value.trim();
const x=document.getElementById('postXUrl').value.trim();
const s=document.getElementById('postThumbnailUrl').value.trim(); // ã‚µãƒ ãƒã‚¤ãƒ«ç”¨URLã‚’è¿½åŠ 
const tagsInput = document.getElementById('postTags').value.trim();

if(!p||!x||!s){
showNotification('Pixiv URL, X URL, ã‚µãƒ ãƒã‚¤ãƒ«ç”¨X URLã®å…¨ã¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
return;
}

const dateStr = getFormattedDate().replace(/-/g, ''); // YYYYMMDD
let id = dateStr;

if(appData.illustrations.find(i=>i.id===id)){
showNotification('ã‚¨ãƒ©ãƒ¼: æœ¬æ—¥ï¼ˆ' + id + 'ï¼‰ã¯æ—¢ã«ä½œå“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚åŒä¸€æ—¥ã«ã¯è¤‡æ•°ä½œå“ã‚’ç™»éŒ²ã§ãã¾ã›ã‚“ã€‚', 'error');
return;
}

const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
if (tags.length === 0) tags.push('æœªåˆ†é¡');

// æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«åˆã‚ã›ã¦ã‚­ãƒ¼åã‚’å¤‰æ›´
const newPost = {
id: id,
p_u: p,
x_u: x,
s_u: s.replace('/status/', '/photo/1'), // ã‚µãƒ ãƒã‚¤ãƒ«URLã‚’ç”»åƒç›´ãƒªãƒ³ã‚¯å½¢å¼ã«å¤‰æ› (X/Twitterç”»åƒURLã®æ…£ç¿’)
tags: tags,
l: [] // å±¥æ­´ (likes_history -> l) ã‚’åˆæœŸåŒ–
};

appData.illustrations.push(newPost);
showNotification('æ–°è¦æŠ•ç¨¿ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚ä¿å­˜ã™ã‚‹ã«ã¯ã€Œæœ¬æ—¥åˆ†ã®ã„ã„ã­ã‚’è¨˜éŒ²ã€å¾Œã«è‡ªå‹•ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹JSONã‚’date.jsonã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚ID: ' + id, 'success');

document.getElementById('postPixivUrl').value = '';
document.getElementById('postXUrl').value = '';
document.getElementById('postThumbnailUrl').value = '';
document.getElementById('postTags').value = '';
renderGallery();
}

function recordAllLikes(){
    // å¤‰æ›´: å…¥åŠ›è¦ç´ ã‚’å‹•çš„ã«ç”Ÿæˆã—ãŸãƒªã‚¹ãƒˆã‹ã‚‰å–å¾—
    const likeItems = document.querySelectorAll('#likeInputContainer .like-item');
    const date=getFormattedDate();
    let totalScore=0;
    let totalLikesCount = 0;
    let recordedWorkCount = 0;

    for(let item of likeItems){
        const id = item.getAttribute('data-work-id');
        const countElement = item.querySelector('.like-count');
        const count = parseInt(countElement.getAttribute('data-count'));

        if(count <= 0) continue; // ã„ã„ã­æ•°ãŒ0ä»¥ä¸‹ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

        const w=appData.illustrations.find(i=>i.id===id);
        if(!w)continue;

        const postedDate = getDateFromId(w.id);
        const days=getElapsedDays(postedDate,date); // çµŒéæ—¥æ•°ã‚’è¨ˆç®—
        const m=getMultiplier(days);

        totalScore += count * (1 * m);
        totalLikesCount += count;
        recordedWorkCount++;

        if(!w.l) w.l = []; // æ–°ã—ã„ã‚­ãƒ¼ 'l' ã‚’ä½¿ç”¨

        // æ—¢å­˜ã®åŒæ—¥è¨˜éŒ²ã‚’æ¢ã™
        const existingEntryIndex = w.l.findIndex(entry => entry.d === date); // 'liked_date' -> 'd'

        if (existingEntryIndex !== -1) {
            // æ—¢å­˜ã®ã‚¨ãƒ³ãƒˆãƒªãŒã‚ã‚Œã°ã€countã‚’åŠ ç®—
            w.l[existingEntryIndex].c += count; // 'count' -> 'c'
        } else {
            // æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ : e (çµŒéæ—¥æ•°) ã¯ä¿å­˜ã—ãªã„
            w.l.push({
                d: date, // liked_date -> d
                c: count // count -> c
            });
        }
    }

    if (recordedWorkCount > 0) {
        // 1. è¨˜éŒ²æˆåŠŸã®é€šçŸ¥
        showNotification(`æœ¬æ—¥åˆ†ã®ã„ã„ã­ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼ˆ${recordedWorkCount}ä½œå“ / åˆè¨ˆã„ã„ã­å›æ•°:${totalLikesCount}å› / ã‚¹ã‚³ã‚¢:${totalScore.toFixed(1)}ï¼‰ã€‚JSONãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸã€‚`, 'success');
        // 2. JSONã‚’ã‚³ãƒ”ãƒ¼
        copyJSON();
        // 3. å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã‚«ã‚¦ãƒ³ãƒˆã‚’0ã«æˆ»ã™ï¼‰
        loadLikeInputs();
        // 4. ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’å†æç”»
        renderGallery();
    } else {
        showNotification('è¨˜éŒ²å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã„ã„ã­æ•°ã‚’1ä»¥ä¸Šã«ã—ã¦ã‹ã‚‰è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚', 'error');
    }
}

function renderGallery(){
const c = document.getElementById('galleryContainer');
c.innerHTML = '';

const analysisSection = document.getElementById('analysisSection');

if (appData.illustrations.length === 0) {
c.innerHTML = '<p>ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
analysisSection.innerHTML = '<p>ä½œå“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
return;
}

// --- ä½œå“ã”ã¨ã®ç·ã‚¹ã‚³ã‚¢ã¨ç·ã„ã„ã­æ•°ã‚’è¨ˆç®— ---
const workScores = {};
const workLikes = {};
appData.illustrations.forEach(w => {
    const postedDate = getDateFromId(w.id);
    const totalScore = (w.l || []).reduce((s, h) => {
     const days = getElapsedDays(postedDate, h.d);
     return s + (h.c * getMultiplier(days));
    }, 0);
    workScores[w.id] = totalScore;
    workLikes[w.id] = (w.l || []).reduce((s, h) => s + h.c, 0); // ç·ã„ã„ã­æ•°ã‚’è¨ˆç®—
});


// --- ã‚¿ã‚°åˆ†æã®è¨ˆç®— (å‡ç­‰å‰²ã‚’é©ç”¨) ---
const tagTotalScores = {}; // ã‚¿ã‚°ã”ã¨ã®åˆè¨ˆã‚¹ã‚³ã‚¢
const tagWorkCounts = {}; // ã‚¿ã‚°ãŒä»˜ã„ã¦ã„ã‚‹ä½œå“ã®æ•°

appData.illustrations.forEach(w => {
(w.tags || []).forEach(tag => {
 // ã‚¿ã‚°ã”ã¨ã®åˆè¨ˆã‚¹ã‚³ã‚¢ã«ã€ãã®ä½œå“ã®ç·ã‚¹ã‚³ã‚¢ã‚’åŠ ç®—
tagTotalScores[tag] = (tagTotalScores[tag] || 0) + workScores[w.id];
 // ã‚¿ã‚°ãŒä»˜ã„ã¦ã„ã‚‹ä½œå“ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
tagWorkCounts[tag] = (tagWorkCounts[tag] || 0) + 1;
});
});

// å‡ç­‰å‰²ã‚’é©ç”¨ã—ã¦æœ€çµ‚çš„ãªã‚¿ã‚°ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
const tagFinalScores = {};
Object.keys(tagTotalScores).forEach(tag => {
 // ã‚¹ã‚³ã‚¢ã‚’ã€ãã®ã‚¿ã‚°ãŒä»˜ã„ã¦ã„ã‚‹ä½œå“ã®æ•°ã§å‰²ã‚‹
tagFinalScores[tag] = tagTotalScores[tag] / tagWorkCounts[tag];
});

const sortedTags = Object.entries(tagFinalScores)
.sort(([, scoreA], [, scoreB]) => scoreB - scoreA);

// --- åˆ†æçµæœã®è¡¨ç¤º ---
let analysisHTML = '<h3>ã‚¿ã‚°åˆ¥è©•ä¾¡ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚° (å‡ç­‰å‰²é©ç”¨)</h3>';
if (sortedTags.length > 0) {
analysisHTML += '<ul>';
sortedTags.forEach(([tag, score]) => {
analysisHTML += `<li>${tag}: <b>${score.toFixed(2)}</b></li>`; // å°æ•°ç‚¹ç¬¬2ä½ã¾ã§è¡¨ç¤º
});
analysisHTML += '</ul>';
} else {
analysisHTML += '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
}
analysisSection.innerHTML = analysisHTML;

// --- ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤º ---
const works = [...appData.illustrations].sort((a,b) => new Date(getDateFromId(b.id)) - new Date(getDateFromId(a.id)));

works.forEach((w, i) => {
const history = w.l || []; // l ã‚’ä½¿ç”¨
const postedDate = getDateFromId(w.id);

// ç·ã„ã„ã­æ•°ã¨ç·ã‚¹ã‚³ã‚¢ã®è¨ˆç®—
const totalLikes = workLikes[w.id]; // workLikesã‹ã‚‰å–å¾—
// workScoresã‹ã‚‰å–å¾—
const totalScore = workScores[w.id];

// æœ€å¾Œã«ã„ã„ã­ã•ã‚ŒãŸæ—¥ä»˜ã‚’ç‰¹å®š (d ã‚’ä½¿ç”¨)
const lastLikedDate = history.length > 0
? history.map(h => h.d)
.sort()
.pop()
: 'â€”';

const tagDisplay = (w.tags || []).join(', ') || 'â€”';

const card = document.createElement('div');
card.className = 'work-card';
card.innerHTML = `
<div class="thumbnail-container">
<div class="thumbnail-image"
style="background-image: url('${w.s_u}');">
</div>
<div class="link-overlay">
<a href="${w.p_u}" target="_blank" class="overlay-button_p">
<img src="${ICON_P}" alt="Pixiv">
</a>
<a href="${w.x_u}" target="_blank" class="overlay-button_x">
<img src="${ICON_X}" alt="X">
</a>
</div>
</div>
<p>æŠ•ç¨¿æ—¥: ${postedDate}</p>
<p>ã‚¿ã‚°: ${tagDisplay}</p>
<p>â™¥: <b>${totalLikes}</b></p>
<p>å‰å›: <b>${lastLikedDate}</b></p>
<p>ã‚¹ã‚³ã‚¢: <b>${totalScore.toFixed(1)}</b></p>
`;
c.appendChild(card);
});
}

/**
* JSONå½¢å¼ã§ã‚³ãƒ”ãƒ¼ã™ã‚‹å‡¦ç† (ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã«åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ç”¨)
*/
function copyJSON(){
// JSONå‡ºåŠ›ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
const outputData = appData.illustrations.map(item => {
const cleanItem = { ...item };

// l (likes_history) ã‚’å‡¦ç†
if (cleanItem.l) {
cleanItem.l = cleanItem.l.map(history => {
// JSONã«å«ã‚ã‚‹ã®ã¯ d, c ã®ã¿ (e ã¯å‰Šé™¤)
return { d: history.d, c: history.c };
});
}

// éå»ã®likes_historyãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤
delete cleanItem.likes_history;
return cleanItem;
});

// å„ä½œå“ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ•´å½¢ã›ãšã«ä¸€è¡Œã§æ–‡å­—åˆ—åŒ–ã—ã€ã‚«ãƒ³ãƒã¨æ”¹è¡Œã§çµåˆ
const illustrationsString = outputData.map(item => JSON.stringify(item)).join(',\n');

// æœ€çµ‚çš„ãªJSONæ§‹é€ 
const jsonText = `{
"illustrations": [
${illustrationsString}
]
}`;

// Clipboard APIã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ”ãƒ¼
navigator.clipboard.writeText(jsonText)
.then(() => {
 // JSONã‚³ãƒ”ãƒ¼æˆåŠŸæ™‚ã®é€šçŸ¥ã¯ recordAllLikes() ã«ç§»å‹•ã—ãŸãŸã‚ã€ã“ã“ã§ã¯è¡Œã‚ãªã„
 console.log('JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
})
.catch(() => showNotification('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'));
}
</script>
</body>
</html>
